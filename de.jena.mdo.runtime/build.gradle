/*
 * Gradle build script for the GeckoExport
 */
import aQute.bnd.gradle.Export

configurations {
  bundles
}

/*
 * Gecko Export task for the named 'bndrun'
 */
task geckoExport(type: Export) {
   description "Export de.jena.mdo.runtime.bndrun"
   group 'export'
   bndrun "de.jena.mdo.runtime.bndrun"
   exporter  'gecko.export'
}

/*
 * Prepare docker build. Copy everything to the right places
 */
task prepareDocker(dependsOn: geckoExport){
	def stageDir = file('generated/docker')
	doFirst {
		stageDir.deleteDir()
    }
    doLast {
		println "Prepare Docker build"
		stageDir.mkdirs()
	     // copy all necessary files to  build/docker/ dir
	    copy {
	        from {
	            zipTree("generated/distributions/gecko.export/de.jena.mdo.runtime.zip")
	        }
	        into stageDir
	    }
    	copy {
	        from new File(stageDir, "docker")
	        into stageDir
	    }
	    copy {
	        from 'docker'
	        into stageDir
	    }
    }
}

/*
 * Executing docker image build. Copy everything to the right places
 */
task buildDocker(type:Exec, dependsOn: prepareDocker){
	
	workingDir 'generated/docker'
    def tag = "mdo/de.jena:latest"
	executable "docker"

	args "build", "-f", "Dockerfile", ".", "-t", tag
	
	doFirst{
		println "Building docker image mdo/de.jena"
	}
}
